<script>
  async function fetchTimetable() {
    const grade = document.getElementById('gradeSelect').value;

    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const formattedDate = `${year}${month}${day}`;
    document.getElementById("today").textContent=`오늘의 시간표   ${year}-${month}-${day}`;

    // 🔑 서버에서 API Key 가져오기
    const keyResponse = await fetch('/api/get-key');
    const keyData = await keyResponse.json();
    const apiKey = keyData.apiKey;

    const educationOfficeCode = 'H10';
    const schoolCode = 7480188;

    let url = `https://open.neis.go.kr/hub/hisTimetable?KEY=${apiKey}&Type=json&pIndex=1&pSize=100&ATPT_OFCDC_SC_CODE=${educationOfficeCode}&SD_SCHUL_CODE=${schoolCode}&ALL_TI_YMD=${formattedDate}`;
    if (grade) {
      url += `&GRADE=${grade}`;
    }

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const timetableData = data.hisTimetable[1].row;
        const timetableBody = document.getElementById('timeTable_body');
        timetableBody.innerHTML = ''; // Clear previous data

        // Populate timetable table
        timetableData.forEach(entry => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${entry.GRADE}</td>
            <td>${entry.CLRM_NM}</td>
            <td>${entry.PERIO}</td>
            <td>${entry.ITRT_CNTNT}</td>
          `;
          timetableBody.appendChild(row);
        });
      })
      .catch(error => {
        console.error('에러 발생:', error);
      });
  }

  // 페이지 로드될 때 오늘의 시간표 조회
  window.onload = function() {
    fetchTimetable();
  };
</script>
